{"version":3,"sources":["../src/router.js"],"names":["AppRouter","app","setupRouters","db","get","uploadDir","upload","req","res","next","status","json","version","session","user","post","array","files","fileModels","each","fileObject","newFile","initWithObject","toJSON","push","length","collection","insertMany","err","result","error","message","from","to","insertedIds","insertOne","sendEmail","sendDownloadLink","info","fileId","params","id","find","_id","toArray","fileName","file","downloader","downloadUrl","getDownloadUrl","redirect","postId","getPostById","archiver","download","console","log","body","create","newUser","auth","checkAuth","isLoggedIn","userId","findById","obj","callback","postObjectId","limit","results","Error","fileIds","$in"],"mappings":"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","file":"router.js","sourcesContent":["import path from 'path'\nimport {version} from '../package.json'\nimport _ from 'lodash'\nimport File from './models/file'\nimport Post from './models/post'\nimport {ObjectID} from 'mongodb'\nimport FileArchiver from './archiver'\nimport Email from './email'\nimport S3 from './s3'\nimport User from './models/user'\nimport Auth from './models/auth'\n\nclass AppRouter {\n\n    constructor(app) {\n        this.app = app;\n        this.setupRouters();\n    }\n\n\n    setupRouters() {\n\n        const app = this.app;\n        const db = app.get('db');\n        const uploadDir = app.get('storageDir');\n        const upload = app.upload;\n\n        // root routing.\n        app.get('/', (req, res, next) => {\n\n            return res.status(200).json({\n                version: version\n            });\n\n        });\n\n        app.get('/api/session', function (req, res, next) {\n            res.json(req.session.user)\n        });\n\n        // Upload routing\n        app.post('/api/upload', upload.array('files'), (req, res, next) => {\n            const files = _.get(req, 'files', []);\n\n\n            let fileModels = [];\n\n\n            _.each(files, (fileObject) => {\n                const newFile = new File(app).initWithObject(fileObject).toJSON();\n                fileModels.push(newFile);\n            });\n\n\n            if (fileModels.length) {\n\n                db.collection('files').insertMany(fileModels, (err, result) => {\n                    if (err) {\n\n                        return res.status(503).json({\n                            error: {\n                                message: \"Unable saved your files.\",\n                            }\n                        });\n                    }\n\n\n                    let post = new Post(app).initWithObject({\n\n                        from: _.get(req, 'body.from'),\n                        to: _.get(req, 'body.to'),\n                        message: _.get(req, 'body.message'),\n                        files: result.insertedIds,\n                    }).toJSON();\n\n\n                    // let save post object to posts collection.\n\n                    db.collection('posts').insertOne(post, (err, result) => {\n\n\n                        if (err) {\n                            return res.status(503).json({error: {message: \"Your upload could not be saved.\"}});\n                        }\n\n                        //implement email sending to user with download link.\n\n                        // send email\n                        const sendEmail = new Email(app).sendDownloadLink(post, (err, info) => {\n\n\n                        });\n\n\n                        // callback to react app with post detail.\n                        return res.json(post);\n\n                    });\n\n\n                });\n\n            } else {\n\n                return res.status(503).json({\n                    error: {message: \"Files upload is required.\"}\n                });\n            }\n        });\n\n        // Download routing\n\n        app.get('/api/download/:id', (req, res, next) => {\n\n            const fileId = req.params.id;\n            db.collection('files').find({_id: ObjectID(fileId)}).toArray((err, result) => {\n\n                const fileName = _.get(result, '[0].name');\n                if (err || !fileName) {\n\n                    return res.status(404).json({\n                        error: {\n                            message: \"File not found.\"\n                        }\n                    })\n                }\n\n\n                // Download file from S3 service\n                const file = _.get(result, '[0]');\n                const downloader = new S3(app, res);\n\n\n                // return downloader.download(file); Proxy download from s3 service\n\n                // Download Directly from S3\n\n\n                const downloadUrl = downloader.getDownloadUrl(file);\n\n                return res.redirect(downloadUrl);\n\n\n\n\n\n\n\n                /*const filePath = path.join(uploadDir, fileName);\n\n                return res.download(filePath, _.get(result, '[0].originalName'), (err) => {\n\n                    if (err) {\n\n                        return res.status(404).json({\n\n                            error: {\n                                message: \"File not found\"\n                            }\n                        });\n                    } else {\n\n                        console.log(\"File is downloaded.\");\n\n                    }\n\n                });*/\n\n\n\n            });\n\n\n        });\n\n\n        // routing for post detail /api/posts/:id\n\n        app.get('/api/posts/:id', (req, res, next) => {\n\n            const postId = _.get(req, 'params.id');\n\n            this.getPostById(postId, (err, result) => {\n\n\n                if (err) {\n                    return res.status(404).json({error: {message: 'File not found.'}});\n                }\n\n                return res.json(result);\n            })\n\n\n        });\n\n        // Routing download zip files.\n        app.get('/api/posts/:id/download', (req, res, next) => {\n\n            const id = _.get(req, 'params.id', null);\n\n\n            this.getPostById(id, (err, result) => {\n\n                if (err) {\n                    return res.status(404).json({error: {message: 'File not found.'}});\n                }\n\n                const files = _.get(result, 'files', []);\n                const archiver = new FileArchiver(app, files, res).download();\n                return archiver;\n\n            })\n        });\n\n\n        // Create new users post\n\n        app.post('/api/users', (req, res, next) => {\n\n        console.log(\"this is the response\", res);\n\n            const body = _.get(req, 'body');\n\n            console.log(\"Data from fontend posted: \", body);\n\n            const user = new User(app);\n            user.initWithObject(body).create((err, newUser) => {\n\n\n                console.log(\"New user created with error & callback\", err, newUser);\n\n\n                if(err){\n                    return res.status(503).json({\n                        error: {message: err}\n                    });\n                }\n                return res.status(200).json(newUser);\n            });\n\n\n\n        });\n\n\n        // // Login user \n\n        // app.post('/api/login', (req, res, next) => {\n\n        //     const body = _.get(req, 'body', {});\n\n        //     const user = new User(app);\n\n        //     const email = _.get(body, 'email');\n        //     const password = _.get(body, 'password');\n\n\n        //     user.login(email, password, (err, token) => {\n\n        //             if(err){\n\n        //                 return res.status(401).json({\n        //                     message: \"An error login your account. Please try again!\"\n        //                 });\n        //             }\n\n        //             return res.status(200).json(token);\n        //     });\n\n\n            \n\n        // });\n\n        // get my profile detail\n        app.get('/api/users/:id', (req, res, next) => {\n\n\n\n            const auth = new Auth(app);\n\n            auth.checkAuth(req, (isLoggedIn) => {\n\n\n                if(!isLoggedIn){\n\n                    return res.status(401).json({\n                        message: \"Unauthorized\"\n                    });\n                }\n\n\n                const userId = _.get(req, 'params.id', null);\n\n                const user = new User(app).findById(userId, (err, obj) => {\n\n\n                        if(err){\n\n                            return res.status(404).json({\n                                message: \"User not found.\"\n                            });\n                        }\n\n                        return res.status(200).json(obj);\n\n                 });\n\n\n\n            });\n\n            \n\n\n\n            \n\n\n        });\n\n    }\n\n\n    getPostById(id, callback = () => {\n    }) {\n\n\n        const app = this.app;\n\n        const db = app.get('db');\n\n\n        let postObjectId = null;\n        try {\n            postObjectId = new ObjectID(id);\n        }\n        catch (err) {\n\n            return callback(err, null);\n\n        }\n\n        db.collection('posts').find({_id: postObjectId}).limit(1).toArray((err, results) => {\n            let result = _.get(results, '[0]');\n\n            if (err || !result) {\n                return callback(err ? err : new Error(\"File not found.\"));\n            }\n\n            const fileIds = _.get(result, 'files', []);\n\n            db.collection('files').find({_id: {$in: fileIds}}).toArray((err, files) => {\n\n                if (err || !files || !files.length) {\n                    return callback(err ? err : new Error(\"File not found.\"));\n                }\n\n                result.files = files;\n\n\n                return callback(null, result);\n\n            });\n\n\n        })\n    }\n\n}\n\n\nexport default AppRouter;"]}