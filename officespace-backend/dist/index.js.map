{"version":3,"sources":["../src/index.js"],"names":["config","update","region","s3","S3","email","createTransport","storageDir","join","__dirname","upload","storage","bucket","metadata","req","file","cb","fieldName","fieldname","key","filename","Date","now","toString","originalname","PORT","app","server","createServer","use","secret","process","env","SESSIONSECRET","resave","saveUninitialized","userSetup","res","next","session","user","id","name","username","profilePic","loggedIn","isAdmin","exposedHeaders","json","limit","set","err","db","console","log","listen","address","port"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;AACA;;;;AACA;;;;AACA;;AAGA;;;;AACA;;;;;;AAFA;AAKA,iBAAIA,MAAJ,CAAWC,MAAX;;AAEA,iBAAID,MAAJ,CAAWE,MAAX;;AAEA,IAAMC,KAAK,IAAI,iBAAIC,EAAR,EAAX;;AAIA;;AAEA,IAAIC,QAAQ,qBAAWC,eAAX,cAAZ;;AAGA;;AAEA,IAAMC,aAAa,eAAKC,IAAL,CAAUC,SAAV,EAAqB,IAArB,EAA2B,SAA3B,CAAnB;;AAGA;;AAEA,IAAMC,SAAS,sBAAO;AAClBC,aAAS,uBAAS;AACdR,YAAIA,EADU;AAEdS,gCAFc;AAGdC,kBAAU,kBAAUC,GAAV,EAAeC,IAAf,EAAqBC,EAArB,EAAyB;AAC/BA,eAAG,IAAH,EAAS,EAACC,WAAWF,KAAKG,SAAjB,EAAT;AACH,SALa;AAMdC,aAAK,aAAUL,GAAV,EAAeC,IAAf,EAAqBC,EAArB,EAAyB;AAC1B,gBAAMI,WAAcC,KAAKC,GAAL,GAAWC,QAAX,EAAd,SAAuCR,KAAKS,YAAlD;AACAR,eAAG,IAAH,EAASI,QAAT;AACH;AATa,KAAT;AADS,CAAP,CAAf;;AAgBA;;AAEA,IAAMK,OAAO,IAAb;AACA,IAAMC,MAAM,wBAAZ;AACAA,IAAIC,MAAJ,GAAa,eAAKC,YAAL,CAAkBF,GAAlB,CAAb;;AAGAA,IAAIG,GAAJ,CAAQ,sBAAO,KAAP,CAAR;AACAH,IAAIG,GAAJ,CAAQ,8BAAQ;AACZC,YAAQC,QAAQC,GAAR,CAAYC,aAAZ,IAA6B,gBADzB;AAEZC,YAAQ,KAFI;AAGZC,uBAAmB;AAHP,CAAR,CAAR;;AAMA,SAASC,SAAT,CAAmBtB,GAAnB,EAAwBuB,GAAxB,EAA6BC,IAA7B,EAAmC;AAC/B,QAAI,CAACxB,IAAIyB,OAAJ,CAAYC,IAAjB,EAAuB;AACnB1B,YAAIyB,OAAJ,CAAYC,IAAZ,GAAmB;AACfC,gBAAI,IADW;AAEfC,kBAAM,EAFS;AAGfC,sBAAU,EAHK;AAIftC,mBAAO,EAJQ;AAKfuC,wBAAY,IALG;AAMfC,sBAAU,KANK;AAOfC,qBAAS;AAPM,SAAnB;AASH;AACDR;AACH;;AAEDZ,IAAIG,GAAJ,CAAQO,SAAR;;AAEAV,IAAIG,GAAJ,CAAQ,oBAAK;AACTkB,oBAAgB;AADP,CAAL,CAAR;;AAIArB,IAAIG,GAAJ,CAAQ,qBAAWmB,IAAX,CAAgB;AACpBC,WAAO;AADa,CAAhB,CAAR;;AAKAvB,IAAIwB,GAAJ,CAAQ,MAAR,EAAgBzC,SAAhB;AACAiB,IAAIwB,GAAJ,CAAQ,YAAR,EAAsB3C,UAAtB;AACAmB,IAAIhB,MAAJ,GAAaA,MAAb;AACAgB,IAAIrB,KAAJ,GAAYA,KAAZ;AACAqB,IAAIvB,EAAJ,GAASA,EAAT;;AAEA;;AAEA,uBAAQ,UAACgD,GAAD,EAAMC,EAAN,EAAa;;AAEjB,QAAGD,GAAH,EAAO;AACHE,gBAAQC,GAAR,CAAY,qCAAZ,EAAmDH,GAAnD;AACA,cAAOA,GAAP;AACH;;AAEDzB,QAAI0B,EAAJ,GAASA,EAAT;AACA1B,QAAIwB,GAAJ,CAAQ,IAAR,EAAcE,EAAd;;AAGA;AACA,yBAAc1B,GAAd;;AAGAA,QAAIC,MAAJ,CAAW4B,MAAX,CAAkBxB,QAAQC,GAAR,CAAYP,IAAZ,IAAoBA,IAAtC,EAA4C,YAAM;AAC9C4B,gBAAQC,GAAR,6BAAsC5B,IAAIC,MAAJ,CAAW6B,OAAX,GAAqBC,IAA3D;AACH,KAFD;AAIH,CAnBD;;kBAuBe/B,G","file":"index.js","sourcesContent":["import http from 'http';\r\nimport express from 'express';\r\nimport session from 'express-session';\r\nimport cors from 'cors';\r\nimport morgan from 'morgan';\r\nimport bodyParser from 'body-parser';\r\nimport multer from 'multer'\r\nimport path from 'path';\r\n\r\nimport {connect} from \"./database\";\r\nimport AppRouter from './router'\r\nimport nodemailer from 'nodemailer'\r\nimport {smtp, s3Config, s3Region,s3Bucket} from './config'\r\n\r\n// Amazon S3 Setup\r\nimport AWS from 'aws-sdk'\r\nimport multerS3 from 'multer-s3'\r\n\r\n\r\nAWS.config.update(s3Config);\r\n\r\nAWS.config.region = s3Region ;\r\n\r\nconst s3 = new AWS.S3();\r\n\r\n\r\n\r\n// Setup Email\r\n\r\nlet email = nodemailer.createTransport(smtp);\r\n\r\n\r\n// File storage config\r\n\r\nconst storageDir = path.join(__dirname, '..', 'storage');\r\n\r\n\r\n//const upload = multer({ storage: storageConfig }); // local upload.\r\n\r\nconst upload = multer({\r\n    storage: multerS3({\r\n        s3: s3,\r\n        bucket: s3Bucket,\r\n        metadata: function (req, file, cb) {\r\n            cb(null, {fieldName: file.fieldname});\r\n        },\r\n        key: function (req, file, cb) {\r\n            const filename = `${Date.now().toString()}-${file.originalname}`;\r\n            cb(null, filename)\r\n        }\r\n    })\r\n})\r\n\r\n\r\n\r\n// End file storage config\r\n\r\nconst PORT = 3000;\r\nconst app = express();\r\napp.server = http.createServer(app);\r\n\r\n\r\napp.use(morgan('dev'));\r\napp.use(session({\r\n    secret: process.env.SESSIONSECRET || \"Coding is fun!\",\r\n    resave: false,\r\n    saveUninitialized: true\r\n}));\r\n\r\nfunction userSetup(req, res, next) {\r\n    if (!req.session.user) {\r\n        req.session.user = {\r\n            id: null,\r\n            name: '',\r\n            username: '',\r\n            email: '',\r\n            profilePic: null,\r\n            loggedIn: false,\r\n            isAdmin: false\r\n        }\r\n    }\r\n    next()\r\n}\r\n\r\napp.use(userSetup);\r\n\r\napp.use(cors({\r\n    exposedHeaders: \"*\"\r\n}));\r\n\r\napp.use(bodyParser.json({\r\n    limit: '50mb'\r\n}));\r\n\r\n\r\napp.set('root', __dirname);\r\napp.set('storageDir', storageDir);\r\napp.upload = upload;\r\napp.email = email;\r\napp.s3 = s3;\r\n\r\n//Connect to the database.\r\n\r\nconnect((err, db) => {\r\n\r\n    if(err){\r\n        console.log(\"An error connecting to the database\", err);\r\n        throw (err);\r\n    }\r\n\r\n    app.db = db;\r\n    app.set('db', db);\r\n\r\n\r\n    // init routers.\r\n    new AppRouter(app);\r\n\r\n\r\n    app.server.listen(process.env.PORT || PORT, () => {\r\n        console.log(`App is running on port ${app.server.address().port}`);\r\n    });\r\n\r\n});\r\n\r\n\r\n\r\nexport default app;"]}