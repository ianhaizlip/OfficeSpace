{"version":3,"sources":["../../src/models/user.js"],"names":["saltRounds","User","app","model","username","email","password","bucket","created","Date","updated","findUserByEmail","bind","login","findById","id","cb","db","query","_id","collection","find","limit","toArray","err","result","user","get","error","message","name","console","log","passwordCheck","compareSync","auth","createToken","token","obj","trim","toLower","errors","length","push","hashPassword","hashSync","validate","messages","each","join","insertOne"],"mappings":"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","file":"user.js","sourcesContent":["import _ from 'lodash'\nimport bcrypt from 'bcrypt'\nimport Auth from './auth'\nimport {ObjectID} from 'mongodb'\n\nconst saltRounds = 10;\n\nexport default class User{\n\n\tconstructor(app){\n\n\t\tthis.app = app;\n\n\t\tthis.model = {\n\t\t\tusername: null,\n\t\t\temail: null,\n\t\t\tpassword: null,\n\t\t\tbucket: null,\n\t\t\tcreated: new Date(),\n\t\t\tupdated: null,\n\t\t}\n\n\t\tthis.findUserByEmail = this.findUserByEmail.bind(this);\n\t\tthis.login = this.login.bind(this);\n\t\tthis.findById = this.findById.bind(this);\n\t}\n\n\tfindById(id = null, cb = () => {}){\n\n\t\tconst db = this.app.db;\n\n\t\tconst query = {\n\t\t\t_id: new ObjectID(id)\n\t\t}\n\t\tdb.collection('users').find(query).limit(1).toArray((err, result) => {\n\n\t\t\tconst user = _.get(result, '[0]');\n\t\t\tif(err === null && user){\n\n\t\t\t\tdelete user.password;\n\t\t\t\t\n\t\t\t\treturn cb(null, user);\n\t\t\t}\n\n\t\t\tconst error = {message: \"User not found.\"}\n\t\t\treturn cb(error, null);\n\t\t})\n\t}\n\tlogin(email, password, cb = () => {}){\n\n\t\tconst app = this.app;\n\n\t\tlet error = null;\n\t\tlet user = {name: \"A\", email: \"test@gmail.com\"};\n\n\t\tconsole.log(\"Email: \", email, \"password:\", password);\n\n\t\tif(!email || !password){\n\n\t\t\terror = {message: \"Email or password is required.\"};\n\t\t\treturn cb(error, null);\n\t\t}\n\n\t\tthis.findUserByEmail(email, (err, user) => {\n\n\t\t\tif(err === null && user){\n\n\t\t\t\tconst passwordCheck = bcrypt.compareSync(password, user.password); // false\n\n\t\t\t\tif(passwordCheck){\n\n\t\t\t\t\t// create new token and return this token key for user and use it for later request.\n\t\t\t\t\tconst auth = new Auth(app);\n\n\n\t\t\t\t\tauth.createToken(user, null, (err, token) => {\n\n\t\t\t\t\t\tif(err){\n\n\t\t\t\t\t\t\terror = {message: \"An error login your account\"};\n\t\t\t\t\t\t\treturn cb(error, null);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdelete user.password;\n\t\t\t\t\t\ttoken.user = user;\n\t\t\t\t\t\treturn cb(null, token);\n\t\t\t\t\t});\n\t\t\n\t\t\t\t}else{\n\n\t\t\t\t\terror = {message: \"Password does not match.\"};\n\n\t\t\t\t\treturn cb(error, null);\n\t\t\t\t}\n\n\t\t\t}\n\t\t\tif(err || !user){\n\t\t\t\terror = {message: \"An error login your account\"};\n\n\t\t\t\treturn cb(error, null);\n\t\t\t}\n\n\t\t});\n\n\t}\n\n\tinitWithObject(obj){\n\n\t\tthis.model.name = _.trim(_.get(obj, 'name', null));\n\t\tthis.model.email = _.toLower(_.trim(_.get(obj, 'email', null)));\n\t\tthis.model.password = _.get(obj, 'password', null);\n\t\tthis.model.bucket = _.trim(_.get(obj, 'bucket', null));\n\n\t\treturn this;\n\t}\n\n\tvalidate(cb = () => {}){\n\n\n\t\tlet errors = [];\n\n\n\t\tconst model = this.model;\n\t\tconst db = this.app.db;\n\n\n\t\tif(model.password.length < 3 ){\n\n\t\t\terrors.push({\n\t\t\t\tmessage: \"Password should more than 3 characters.\"\n\t\t\t});\n\t\t}\n\n\t\tthis.findUserByEmail(model.email, (err, user) => {\n\n\n\t\t\tif(err || user){\n\n\t\t\t\terrors.push({message: \"Email already exists.\"});\n\t\t\t}\n\n\n\t\t\treturn cb(errors);\n\t\t});\n\t}\n\n\tfindUserByEmail(email = null, cb = () => {}){\n\t\tconst db = this.app.db;\n\n\t\tconst query = {\n\t\t\temail: email\n\t\t};\n\n\t\tdb.collection('users').find(query).limit(1).toArray((err, result) => {\n\t\t\treturn cb(err, _.get(result, '[0]', null));\n\t\t}); \n\t}\n\tcreate(cb){\n\n\t\tlet model = this.model;\n\t\tconst db = this.app.db;\n\n\t\tconst hashPassword = bcrypt.hashSync(model.password, saltRounds);\n\t\tmodel.password = hashPassword;\n\t\t\n\t\tthis.validate((errors) => {\n\n\t\t\tlet messages = [];\n\n\t\t\tif(errors.length > 0){\n\n\t\t\t\t_.each(errors, (err) => {\n\n\t\t\t\t\tmessages.push(err.message);\n\t\t\t\t});\n\n\t\t\t\treturn cb(_.join(messages, ','), null);\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\tdb.collection('users').insertOne(model, (err, result) => {\n\t\t\t\t\treturn cb(err, model);\n\t\t\t});\n\t\t});\n\t}\n}"]}