{"version":3,"sources":["../../src/models/user.js"],"names":["saltRounds","User","app","model","name","email","password","created","Date","updated","findUserByEmail","bind","login","findById","id","cb","db","query","_id","collection","find","limit","toArray","err","result","user","get","error","message","console","log","passwordCheck","compareSync","auth","createToken","token","obj","trim","toLower","errors","length","push","hashPassword","hashSync","validate","messages","each","join","insertOne"],"mappings":"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","file":"user.js","sourcesContent":["import _ from 'lodash'\r\nimport bcrypt from 'bcrypt'\r\nimport Auth from './auth'\r\nimport {ObjectID} from 'mongodb'\r\n\r\nconst saltRounds = 10;\r\n\r\nexport default class User{\r\n\r\n\r\n\r\n\tconstructor(app){\r\n\r\n\t\tthis.app = app;\r\n\r\n\r\n\r\n\t\tthis.model = {\r\n\t\t\tname: null,\r\n\t\t\temail: null,\r\n\t\t\tpassword: null,\r\n\t\t\tcreated: new Date(),\r\n\t\t\tupdated: null,\r\n\t\t}\r\n\r\n\r\n\t\tthis.findUserByEmail = this.findUserByEmail.bind(this);\r\n\t\tthis.login = this.login.bind(this);\r\n\t\tthis.findById = this.findById.bind(this);\r\n\t}\r\n\r\n\r\n\tfindById(id = null, cb = () => {}){\r\n\r\n\r\n\t\tconst db = this.app.db;\r\n\r\n\t\tconst query = {\r\n\t\t\t_id: new ObjectID(id)\r\n\t\t}\r\n\t\tdb.collection('users').find(query).limit(1).toArray((err, result) => {\r\n\r\n\t\t\tconst user = _.get(result, '[0]');\r\n\t\t\tif(err === null && user){\r\n\r\n\t\t\t\tdelete user.password;\r\n\t\t\t\t\r\n\t\t\t\treturn cb(null, user);\r\n\t\t\t}\r\n\r\n\t\t\tconst error = {message: \"User not found.\"}\r\n\t\t\treturn cb(error, null);\r\n\t\t})\r\n\t}\r\n\tlogin(email, password, cb = () => {}){\r\n\r\n\t\tconst app = this.app;\r\n\r\n\t\tlet error = null;\r\n\t\tlet user = {name: \"A\", email: \"test@gmail.com\"};\r\n\r\n\t\tconsole.log(\"Email: \", email, \"password:\", password);\r\n\r\n\t\tif(!email || !password){\r\n\r\n\t\t\terror = {message: \"Email or password is required.\"};\r\n\t\t\treturn cb(error, null);\r\n\t\t}\r\n\r\n\t\tthis.findUserByEmail(email, (err, user) => {\r\n\r\n\r\n\t\t\tif(err === null && user){\r\n\r\n\t\t\t\r\n\r\n\t\t\t\tconst passwordCheck = bcrypt.compareSync(password, user.password); // false\r\n\r\n\t\t\t\r\n\r\n\t\t\t\tif(passwordCheck){\r\n\r\n\t\t\t\t\t// create new token and return this token key for user and use it for later request.\r\n\t\t\t\t\tconst auth = new Auth(app);\r\n\r\n\r\n\t\t\t\t\tauth.createToken(user, null, (err, token) => {\r\n\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t\t\t\tif(err){\r\n\r\n\t\t\t\t\t\t\terror = {message: \"An error login your account\"};\r\n\t\t\t\t\t\t\treturn cb(error, null);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tdelete user.password;\r\n\t\t\t\t\t\ttoken.user = user;\r\n\t\t\t\t\t\treturn cb(null, token);\r\n\r\n\t\t\t\t\t});\r\n\r\n\r\n\t\t\t\t\t\r\n\t\t\t\t}else{\r\n\r\n\t\t\t\t\terror = {message: \"Password does not match.\"};\r\n\r\n\t\t\t\t\treturn cb(error, null);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t\r\n\r\n\t\t\t}\r\n\t\t\tif(err || !user){\r\n\t\t\t\terror = {message: \"An error login your account\"};\r\n\r\n\t\t\t\treturn cb(error, null);\r\n\t\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\t\t});\r\n\r\n\t\t\r\n\t}\r\n\r\n\tinitWithObject(obj){\r\n\r\n\t\tthis.model.name = _.trim(_.get(obj, 'name', null));\r\n\t\tthis.model.email = _.toLower(_.trim(_.get(obj, 'email', null)));\r\n\t\tthis.model.password = _.get(obj, 'password', null);\r\n\r\n\r\n\r\n\r\n\t\treturn this;\r\n\t}\r\n\r\n\tvalidate(cb = () => {}){\r\n\r\n\r\n\t\tlet errors = [];\r\n\r\n\r\n\t\tconst model = this.model;\r\n\t\tconst db = this.app.db;\r\n\r\n\r\n\t\tif(model.password.length < 3 ){\r\n\r\n\t\t\terrors.push({\r\n\t\t\t\tmessage: \"Password should more than 3 characters.\"\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t\r\n\r\n\t\t\r\n\r\n\t\tthis.findUserByEmail(model.email, (err, user) => {\r\n\r\n\r\n\t\t\tif(err || user){\r\n\r\n\t\t\t\terrors.push({message: \"Email already exists.\"});\r\n\t\t\t}\r\n\r\n\r\n\t\t\treturn cb(errors);\r\n\t\t});\r\n\r\n\r\n\r\n\t}\r\n\r\n\tfindUserByEmail(email = null, cb = () => {}){\r\n\t\tconst db = this.app.db;\r\n\r\n\t\tconst query = {\r\n\t\t\temail: email\r\n\t\t};\r\n\r\n\t\tdb.collection('users').find(query).limit(1).toArray((err, result) => {\r\n\t\t\treturn cb(err, _.get(result, '[0]', null));\r\n\t\t}); \r\n\r\n\r\n\t}\r\n\tcreate(cb){\r\n\r\n\t\tlet model = this.model;\r\n\t\tconst db = this.app.db;\r\n\r\n\t\tconst hashPassword = bcrypt.hashSync(model.password, saltRounds);\r\n\t\tmodel.password = hashPassword;\r\n\t\t\r\n\t\tthis.validate((errors) => {\r\n\r\n\r\n\r\n\t\t\tlet messages = [];\r\n\r\n\t\t\tif(errors.length > 0){\r\n\r\n\t\t\t\t_.each(errors, (err) => {\r\n\r\n\t\t\t\t\tmessages.push(err.message);\r\n\t\t\t\t});\r\n\r\n\t\t\t\treturn cb(_.join(messages, ','), null);\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tdb.collection('users').insertOne(model, (err, result) => {\r\n\t\t\t\t\treturn cb(err, model);\r\n\t\t\t});\r\n\r\n\t\t});\r\n\r\n\r\n\t\t\r\n\r\n\t}\r\n\r\n}"]}